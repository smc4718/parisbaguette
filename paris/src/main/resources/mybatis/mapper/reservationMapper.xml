<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pyj.paris.dao.ReservationMapper">

    <resultMap id="ReservationMap" type="ReservationDto">
        <id     column="RESERVATION_NO"    property="reservationNo" />
        <result column="USER_NO"           property="userNo" />
        <result column="RESERVATION_DATE"  property="reservationDate" />
        <result column="STATUS"            property="status" />
        <result column="CREATED_AT"        property="createdAt" />
        <association javaType="UserDto"     property="userDto">
            <id         column="USER_NO"         property="userNo" />
            <result     column="ID"              property="id" />
            <result     column="PW"              property="pw" />
            <result     column="NAME"            property="name" />
            <result     column="GENDER"          property="gender" />
            <result     column="EMAIL"           property="email" />
            <result     column="HP"              property="hp" />
            <result     column="HP_SMS_YN"       property="hpSmsYn" />
            <result     column="JOINED_AT"       property="joinedAt" />
        </association>
    </resultMap>

    <!-- 예약 요청 -->
    <insert id="insertReservation" parameterType="ReservationDto">
        <selectKey order="BEFORE" keyProperty="reservationNo" resultType="int">
            SELECT RESERVATION_SEQ.NEXTVAL
            FROM DUAL
        </selectKey>
        INSERT INTO RESERVATION_T(
            RESERVATION_NO
          , USER_NO
          , RESERVATION_DATE
          , STATUS
        ) VALUES (
            #{reservationNo}
          , #{userNo}
          , #{reservationDate}
          , 'PENDING'
        )
    </insert>

    <!-- 관리자가 예약 승인 -->
    <update id="approveReservation" parameterType="int">
        UPDATE RESERVATION_T
           SET STATUS = 'APPROVED'
         WHERE RESERVATION_NO = #{reservationNo}
    </update>

    <!-- 관리자가 예약 거절 -->
    <update id="rejectReservation" parameterType="int">
        UPDATE RESERVATION_T
           SET STATUS = 'REJECTED'
         WHERE RESERVATION_NO = #{reservationNo}
    </update>

    <!-- 예약 목록 조회 (관리자가 확인) -->
    <select id="getPendingReservations" resultMap="ReservationMap">
        SELECT *
          FROM RESERVATION_T
         WHERE STATUS = 'PENDING'
         ORDER BY CREATED_AT DESC
    </select>

    <!-- 특정 사용자의 예약 내역 조회 -->
    <select id="getUserReservations" parameterType="int" resultMap="ReservationMap">
        SELECT *
          FROM RESERVATION_T
         WHERE USER_NO = #{userNo}
         ORDER BY RESERVATION_DATE DESC
    </select>

</mapper>
